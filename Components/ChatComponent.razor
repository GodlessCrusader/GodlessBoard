@using GodlessBoard.Data
@using GodlessBoard.Models
@using GodlessBoard.Services
@inject MyDbContext _dbContext
@inject HttpContext _httpContext

<div id="MessageHistoryContainer">
    @{
        foreach (var m in Chat.Messages)
        {
            <img src="@m.User.ProfilePicUrl">
            <label>@m.Text</label>
            <label>@m.RecievingTime.ToString()</label>
        }
    }
</div>
<textarea>@SentMessageText</textarea>
<button class="btn btn-outline-primary">Send</button>

@code {

    [Parameter]
    public Chat Chat { get; set; }
    public string SentMessageText { get; set; } = "";
    public async Task SendMessageAsync()
    {
        if (!string.IsNullOrEmpty(SentMessageText))
        {
            var currentUser = _dbContext.Users.Where(x => x.UserName == Auth.GetUserName(_httpContext.User.Identity.Name)).Single();
            var sentMessage = new ChatMessage() { Text = SentMessageText, Chat=Chat, User = currentUser};
            Chat.Messages.Add(sentMessage);
            await _dbContext.Messages.AddAsync(sentMessage);
            await _dbContext.SaveChangesAsync();
        }
        
    }
}
