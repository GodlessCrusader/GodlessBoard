@using GodlessBoard.Data
@using GodlessBoard.Models
@using GodlessBoard.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using System.Net.Http.Headers
@inject IConfiguration Configuration
@inject MyDbContext _context
@inject IHttpContextAccessor HttpContextAcessor
@inject HttpClient client
@page "/"
<form>
    <label>Profile picture</label>
    <InputFile OnChange="UploadImage" />
    <button @onclick="ChangeButtonText">Change profile picture</button>
    <span class="text-dngr">@SpanText</span>
</form>
<label>@exception</label>
<button @onclick="@ChangeButtonText">@buttonText</button>
@code {
    [Parameter]
    public User? CurrentUser { get; set; }
    public string SpanText { get; set; } = string.Empty;
    string exception = string.Empty;
    public string buttonText { get; set; } = "buttonText";
    private void ChangeButtonText()
    {
        buttonText = "sas";
    }
    private async Task UploadImage(InputFileChangeEventArgs e)
    {
        if(!e.File.ContentType.Contains("image") || CurrentUser == null)
        {
            SpanText = "Wrong file type";
            return;
        }else if( CurrentUser == null)
        {
            SpanText = "Authorization error. Please log in or sign up a new account";
            return;
        }else if(CurrentUser.MaxMediaWeight - CurrentUser.CurrentMediaWeight < (ulong)e.File.Size)
        {
            SpanText = "Media storage size limitation reached";
            return;
        }else
        {
            var mediaName = Path.GetRandomFileName().Replace(".",string.Empty) + Path.GetExtension(e.File.Name);
            var media = new Media()
            {
                Name = mediaName,
                Type = MediaType.Image,
                Owner = _context.Users.Where(x => x.Id == CurrentUser.Id).Single(),
                Weight = e.File.Size
            };

            _context.Users.Where(x => x.Id == CurrentUser.Id).Single().ProfilePicUrl = $"{media.Name}";
            _context.Media.Add(media);
            _context.SaveChanges();

            var imageUploadPath = @"D:\pseudoroot\visualCodeProjects\prog\MediaFiles\Images\" + mediaName;
            using var fs = new FileStream( imageUploadPath ,FileMode.Create);
            await e.File.OpenReadStream().CopyToAsync(fs);
        }
        
    }
}
